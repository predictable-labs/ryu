name: Deploy Extensions

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to download artifacts from (leave empty to use latest)'
        required: false
        type: string
  workflow_call:

jobs:
  deploy-extensions:
    runs-on: self-hosted
    permissions:
      packages: write
    steps:
      - name: Free disk space on Ubuntu runner
        uses: kfir4444/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true
      
      - uses: actions/checkout@v4

      - name: Restructure directories
        run: |
          mv scripts/extension ../extension-scripts
          rm -rf *
          mv ../extension-scripts/* .

      - name: Download artifacts from previous run
        if: ${{ inputs.run_id != '' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-and-deploy-extension.yml
          run_id: ${{ inputs.run_id }}
          name: ryu-extensions
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts from current run
        if: ${{ inputs.run_id == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ryu-extensions

      - name: Ensure dataset directory exists
        run: |
          mkdir -p dataset
          if [ ! "$(ls -A dataset)" ]; then
            echo "Dataset directory is empty, creating placeholder"
            echo "# Dataset placeholder" > dataset/README.md
          fi

      - name: Debug - List files
        run: |
          echo "Current directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Checking for Dockerfile:"
          test -f Dockerfile && echo "Dockerfile exists" || echo "Dockerfile NOT found"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/ryugraph/extension-repo:latest
